name: Deploy to Fabric

on:
  push:
    branches:
      - '*dev*'  # Auto-deploy to DEV for any branch with 'dev' in name
      - main     # Auto-deploy to TEST
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
      skip_tests:
        description: 'Skip smoke tests'
        required: false
        type: boolean
        default: false

jobs:
  determine-environment:
    name: Determine Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    
    steps:
      - name: Set environment based on trigger
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"dev"* ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=test" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    needs: determine-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: ðŸ” Authenticate to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸŽ« Get Fabric Access Token
        run: |
          TOKEN=$(az account get-access-token --resource https://analysis.windows.net/powerbi/api --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "âœ… Fabric token acquired"
      
      - name: Backup Current Workspace
        id: backup
        run: |
          echo "ðŸ”„ Creating backup before deployment..."
          BACKUP_ID="backup-$(date +%Y%m%d-%H%M%S)"
          
          # Determine workspace ID based on environment
          ENV="${{ needs.determine-environment.outputs.environment }}"
          if [ "$ENV" == "dev" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_DEV_WORKSPACE_ID }}"
          elif [ "$ENV" == "test" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_TEST_WORKSPACE_ID }}"
          elif [ "$ENV" == "prod" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_PROD_WORKSPACE_ID }}"
          fi
          
          python scripts/backup_workspace.py \
            --workspace-id "$WORKSPACE_ID" \
            --backup-id "$BACKUP_ID" \
            --output-path "backups/"
          
          echo "backup_id=$BACKUP_ID" >> $GITHUB_OUTPUT
          echo "âœ… Backup completed: $BACKUP_ID"
      
      - name: Deploy to Fabric
        run: |
          echo "ðŸš€ Deploying to ${{ needs.determine-environment.outputs.environment }} environment..."
          
          # Determine workspace ID based on environment
          ENV="${{ needs.determine-environment.outputs.environment }}"
          if [ "$ENV" == "dev" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_DEV_WORKSPACE_ID }}"
          elif [ "$ENV" == "test" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_TEST_WORKSPACE_ID }}"
          elif [ "$ENV" == "prod" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_PROD_WORKSPACE_ID }}"
          fi
          
          python scripts/deploy_to_fabric.py \
            --workspace-id "$WORKSPACE_ID" \
            --environment ${{ needs.determine-environment.outputs.environment }} \
            --artifact-type all \
            --artifacts-path .
          
          echo "âœ… Deployment completed"
      
      - name: Validate Deployment
        run: |
          echo "ðŸ” Validating deployment..."
          python scripts/validate_deployment.py \
            --environment ${{ needs.determine-environment.outputs.environment }}
          echo "âœ… Deployment validation passed"
      
      - name: Run Smoke Tests
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "ðŸ§ª Running smoke tests..."
          python scripts/run_smoke_tests.py \
            --environment ${{ needs.determine-environment.outputs.environment }}
          echo "âœ… Smoke tests passed"
      
      - name: Run Integration Tests
        if: ${{ needs.determine-environment.outputs.environment == 'test' }}
        run: |
          echo "ðŸ”— Running integration tests..."
          python scripts/run_integration_tests.py
          echo "âœ… Integration tests passed"
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ NVR Fabric Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployed Components" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Semantic Models (Model01, Model02, Model03)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Power BI Reports (Report01-05)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Notebooks (data_ingestion, model_training)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pipelines (customer_analytics_pipeline)" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Initiating rollback..."
          
          # Determine workspace ID based on environment
          ENV="${{ needs.determine-environment.outputs.environment }}"
          if [ "$ENV" == "dev" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_DEV_WORKSPACE_ID }}"
          elif [ "$ENV" == "test" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_TEST_WORKSPACE_ID }}"
          elif [ "$ENV" == "prod" ]; then
            WORKSPACE_ID="${{ secrets.FABRIC_PROD_WORKSPACE_ID }}"
          fi
          
          python scripts/rollback_deployment.py \
            --workspace-id "$WORKSPACE_ID" \
            --backup-path "backups/${{ steps.backup.outputs.backup_id }}" || echo "âš ï¸ Rollback failed or not configured"

  post-deployment:
    name: Post-Deployment Tasks
    needs: [determine-environment, deploy]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update Deployment Tracking
        run: |
          echo "ðŸ“Š Updating deployment tracking..."
          echo "Deployment to ${{ needs.determine-environment.outputs.environment }} completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> DEPLOYMENT_LOG.md
          echo "Commit: ${{ github.sha }}" >> DEPLOYMENT_LOG.md
          echo "---" >> DEPLOYMENT_LOG.md
      
      - name: Send Teams Notification
        if: ${{ needs.determine-environment.outputs.environment == 'prod' }}
        run: |
          echo "ðŸ“¢ Sending Teams notification for production deployment..."
          # Add Teams webhook integration here
          # curl -X POST ${{ secrets.TEAMS_WEBHOOK_URL }} -H 'Content-Type: application/json' -d '...'
